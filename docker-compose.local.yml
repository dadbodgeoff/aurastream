# =============================================================================
# AuraStream - Local Development Docker Compose
# =============================================================================
# Identical to docker-compose.prod.yml but points to localhost instead of prod.
# 
# Usage: docker compose -f docker-compose.local.yml up -d
# 
# PORT ALLOCATION:
# - API:   8001 (external) -> 8000 (internal)
# - Web:   3000 (external) -> 3000 (internal)
# - Redis: 6381 (external) -> 6379 (internal)
# =============================================================================

services:
  # =============================================================================
  # Backend API - Port 8001
  # =============================================================================
  
  aurastream-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-api
    ports:
      - "8001:8000"
    environment:
      - APP_ENV=production
      - DEBUG=false
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --workers 4
    networks:
      - aurastream-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # =============================================================================
  # Redis (Job Queue & Cache) - Port 6381
  # =============================================================================
  
  aurastream-redis:
    image: redis:7-alpine
    container_name: aurastream-redis
    ports:
      - "6381:6379"
    volumes:
      - aurastream_redis_data:/data
    networks:
      - aurastream-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # Background Workers (no external port needed)
  # =============================================================================
  
  aurastream-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: rq worker --url redis://aurastream-redis:6379 generation
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M

  # =============================================================================
  # Twitch Generation Worker - Processes Twitch-specific asset generation jobs
  # =============================================================================
  
  aurastream-twitch-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: rq worker --url redis://aurastream-redis:6379 twitch_generation
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # =============================================================================
  # Head Orchestrator - Enterprise-grade orchestration of all workers
  # =============================================================================
  
  aurastream-head-orchestrator:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-head-orchestrator
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: python -m backend.workers.orchestrator.orchestrator
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # =============================================================================
  # Intel V2 Orchestrator - Enterprise analytics with quota-aware collection
  # =============================================================================
  
  aurastream-intel-v2-orchestrator:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-intel-v2-orchestrator
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: python -m backend.workers.intel.cli start
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # =============================================================================
  # Playbook Worker - Generates algorithmic playbook reports every 4 hours
  # =============================================================================
  
  aurastream-playbook-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-playbook-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.playbook_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # =============================================================================
  # Creator Intel Worker - Pre-computes keywords, tags, titles, video ideas every 4 hours
  # =============================================================================
  
  aurastream-creator-intel-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-creator-intel-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.creator_intel_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # =============================================================================
  # Twitch Streams Worker - Fetches Twitch stream data every 15 minutes
  # =============================================================================
  
  aurastream-twitch-streams-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-twitch-streams-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: python -m backend.workers.twitch_streams_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # =============================================================================
  # Thumbnail Intel Worker - Analyzes gaming thumbnails daily at 6 AM EST
  # =============================================================================
  
  aurastream-thumbnail-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-thumbnail-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.thumbnail_intel_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # YouTube Worker - Fetches YouTube trending data every 30 minutes
  # =============================================================================
  
  aurastream-youtube-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-youtube-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: python -m backend.workers.youtube_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Clip Radar Worker - Polls Twitch clips every 5 minutes for viral detection
  # =============================================================================
  
  aurastream-clip-radar-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-clip-radar-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
    command: python -m backend.workers.clip_radar_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Clip Radar Recap Worker - Daily clip compression at 6 AM UTC
  # =============================================================================
  
  aurastream-clip-recap-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-clip-recap-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.clip_radar_recap_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Analytics Flush Worker - Flushes Redis analytics to PostgreSQL hourly
  # =============================================================================
  
  aurastream-analytics-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-analytics-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.analytics_flush_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Intel Aggregation Worker - Hourly/Daily aggregation of intel data
  # =============================================================================
  
  aurastream-intel-aggregation-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: aurastream-intel-aggregation-worker
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
    env_file:
      - ./backend/.env
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: python -m backend.workers.intel_aggregation_worker
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Alert Animation Worker - Depth map generation and animation exports
  # =============================================================================
  
  aurastream-alert-animation-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - APP_ENV=production
      - REDIS_URL=redis://aurastream-redis:6379
      - PYTHONPATH=/app/backend
      - HF_HOME=/app/.cache/huggingface
      - TRANSFORMERS_CACHE=/app/.cache/huggingface
    env_file:
      - ./backend/.env
    volumes:
      - aurastream_alert_animation_cache:/app/.cache
    depends_on:
      aurastream-redis:
        condition: service_healthy
      aurastream-api:
        condition: service_healthy
    command: rq worker --url redis://aurastream-redis:6379 alert_animation
    networks:
      - aurastream-net
    restart: unless-stopped
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # =============================================================================
  # Next.js Frontend - Port 3000 (LOCAL - points to localhost:8001)
  # =============================================================================
  
  aurastream-web:
    build:
      context: ./tsx
      dockerfile: apps/web/Dockerfile
      target: prod
      args:
        - NEXT_PUBLIC_API_URL=http://localhost:8001
        - NEXT_PUBLIC_APP_URL=http://localhost:3000
        - NEXT_PUBLIC_SUPABASE_URL=https://qgyvdadgdomnubngfpun.supabase.co
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFneXZkYWRnZG9tbnVibmdmcHVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NDEzMzIsImV4cCI6MjA4MjExNzMzMn0.prP5BzHMW9DaM3MY7CjfWiMOgVjCnYADmjcSacqrA00
    container_name: aurastream-web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
    depends_on:
      aurastream-api:
        condition: service_healthy
    networks:
      - aurastream-net
    restart: unless-stopped

networks:
  aurastream-net:
    driver: bridge
    name: aurastream-net

volumes:
  aurastream_redis_data:
    name: aurastream_redis_data
  aurastream_alert_animation_cache:
    name: aurastream_alert_animation_cache
